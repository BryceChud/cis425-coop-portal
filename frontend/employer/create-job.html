<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Job Posting</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        #saveMsg {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }
        #saveMsg.success { background: #4CAF50; color: #fff; }
        #saveMsg.error   { background: #c0392b; color: #fff; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <img class="header-logo" src="../assets/logo.png" alt="Logo">
        <div class="header-title">Create Job Posting</div>
        <div>
            <button class="home-btn" onclick="location.href='dashboard.html'">Home</button>
            <button class="logout-btn" onclick="location.href='../index.html'">Logout</button>
        </div>
    </div>

    <!-- FORM CARD -->
    <div class="large-card">
        <h2>Job Details</h2>

        <form id="createJobForm">
            <label for="jobTitle">Job Title</label>
            <input id="jobTitle" class="input-field" type="text" required>

            <label for="jobDescription">Description</label>
            <textarea id="jobDescription" rows="4"></textarea>

            <label for="numWeeks">Weeks</label>
            <input id="numWeeks" class="input-field" type="number" min="0">

            <label for="numHours">Hours Per Week</label>
            <input id="numHours" class="input-field" type="number" min="0">

            <label for="jobLocation">Location</label>
            <input id="jobLocation" class="input-field" type="text">

            <label for="majorSelect">Majors of Interest</label>
            <!-- multiple-select, options loaded from /api/majors -->
            <select id="majorSelect" class="input-field" multiple size="5">
                <!-- options injected by JS -->
            </select>

            <label for="reqSkills">Required Skills</label>
            <input id="reqSkills" class="input-field" type="text">

            <label for="prefSkills">Preferred Skills</label>
            <input id="prefSkills" class="input-field" type="text">

            <label for="salary">Salary</label>
            <input id="salary" class="input-field" type="number" step="0.01" min="0">

            <label for="status">Status</label>
            <select id="status" class="input-field">
                <option value="open">Open – Accepting Applications</option>
                <option value="pending">Pending – Offer Processing</option>
                <option value="closed">Closed – Position Filled</option>
            </select>

            <button class="full-btn" type="submit">Submit</button>
        </form>

        <div id="saveMsg"></div>
    </div>

<script>
function getEmployerIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("employerId") || "1"; // default
}

async function loadMajors() {
    const select = document.getElementById("majorSelect");
    select.innerHTML = "<option disabled>Loading majors...</option>";

    try {
        const res = await fetch("/api/majors");
        if (!res.ok) {
            throw new Error(await res.text());
        }
        const majors = await res.json();

        select.innerHTML = ""; // clear
        majors.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.majorId;      // numeric id
            opt.textContent = m.majorName;
            select.appendChild(opt);
        });

        if (majors.length === 0) {
            const opt = document.createElement("option");
            opt.disabled = true;
            opt.textContent = "No majors found";
            select.appendChild(opt);
        }
    } catch (err) {
        console.error("Error loading majors:", err);
        select.innerHTML = "";
        const opt = document.createElement("option");
        opt.disabled = true;
        opt.textContent = "Error loading majors";
        select.appendChild(opt);
    }
}

function showMessage(text, isError = false) {
    const msg = document.getElementById("saveMsg");
    msg.textContent = text;
    msg.className = isError ? "error" : "success";
    msg.style.display = "block";
    setTimeout(() => (msg.style.display = "none"), 3000);
}

document.addEventListener("DOMContentLoaded", () => {
    loadMajors();

    const form = document.getElementById("createJobForm");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const employerId = getEmployerIdFromUrl();

        const title = document.getElementById("jobTitle").value.trim();
        const description = document.getElementById("jobDescription").value.trim();
        const numWeeks = document.getElementById("numWeeks").value;
        const numHours = document.getElementById("numHours").value;
        const location = document.getElementById("jobLocation").value.trim();
        const reqSkills = document.getElementById("reqSkills").value.trim();
        const prefSkills = document.getElementById("prefSkills").value.trim();
        const salary = document.getElementById("salary").value;
        const status = document.getElementById("status").value;

        const majorSelect = document.getElementById("majorSelect");
        const majorIds = Array.from(majorSelect.selectedOptions).map(opt =>
            Number(opt.value)
        );

        if (!title) {
            showMessage("Job title is required.", true);
            return;
        }
        if (!employerId) {
            showMessage("Missing employerId (check URL or login).", true);
            return;
        }

        const payload = {
            employerId: Number(employerId),
            title,
            description,
            numWeeks: numWeeks ? Number(numWeeks) : null,
            numHours: numHours ? Number(numHours) : null,
            location,
            reqSkills,
            prefSkills,
            salary: salary ? Number(salary) : null,
            status,
            majorIds
        };

        try {
            const res = await fetch("/api/jobs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                console.error("Error from /api/jobs:", text);
                showMessage("Error creating job. See console for details.", true);
                return;
            }

            const data = await res.json();
            showMessage(`Job created successfully (JobID = ${data.jobId}).`, false);
            form.reset();
            // optionally clear majors selection
            Array.from(majorSelect.options).forEach(o => (o.selected = false));
        } catch (err) {
            console.error("Network error creating job:", err);
            showMessage("Network error while creating job.", true);
        }
    });
});
</script>

</body>
</html>
