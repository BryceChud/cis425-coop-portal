<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">

    <style>
        .actions-row {
            display: flex;
            gap: 30px;
            margin-bottom: 35px;
        }

        .card {
            background: #043B72;
            padding: 20px;
            border-radius: 10px;
            width: 270px;
            height: 160px;
            color: white;
        }

        .card h3 {
            color: #FFCB05;
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            border: 1px solid #0A2F56;
            padding: 12px;
            text-align: left;
            color: white;
        }

        table th {
            background-color: #043B72;
        }

        .no-results {
            color: white;
            text-align: center;
            margin-top: 40px;
            font-size: 18px;
            opacity: 0.85;
        }

        button {
            padding: 8px 16px;
            background: #FFCB05;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #e0b606;
        }
    </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="../assets/logo.png" class="header-logo">
    <h1 class="header-title">Student Dashboard</h1>

    <div>
        <button class="home-btn" onclick="goHome()">Home</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="container">

    <h2>Student Actions</h2>

    <!-- SIDE-BY-SIDE ACTION CARDS -->
    <div class="actions-row">

        <!-- Profile Card -->
        <div class="card">
            <h3>My Profile</h3>
            <p>Update your academic and personal information.</p>
            <button onclick="window.location.href='profile.html'">Open</button>
        </div>

        <!-- Co-op Summary Card -->
        <div class="card">
            <h3>Submit Co-op Summary</h3>
            <p>Required for earning co-op course credit.</p>
            <button onclick="window.location.href='summary.html'">Submit</button>
        </div>

    </div>

    <h2>Search Internships</h2>

    <!-- SEARCH BAR -->
    <input id="keyword" placeholder="Keyword">

    <select id="majorFilter">
        <option value="">Any Major</option>
        <option value="CS">CS</option>
        <option value="SWE">SWE</option>
        <option value="ITM">ITM</option>
    </select>

    <select id="locationFilter">
        <option value="">Any Location</option>
        <option value="Remote">Remote</option>
        <option value="Detroit">Detroit</option>
        <option value="Ann Arbor">Ann Arbor</option>
    </select>

    <button onclick="searchInternships()">Search</button>

    <!-- PLACEHOLDER BEFORE SEARCH -->
    <p id="placeholder" class="no-results">
        No internships to display. Use the search fields above to begin.
    </p>

    <!-- RESULTS TABLE -->
    <table id="resultsTable" style="display:none;">
        <thead>
            <tr>
                <th>Position</th>
                <th>Employer</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
    </table>

</div>

<!-- LOGIC -->
<script>
function logout() {
    window.location.href = "../index.html";
}

function goHome() {
    window.location.href = "dashboard.html";
}

// TODO: replace this with real login / session logic
function getCurrentStudentId() {
    return 1001; // TEMP: change to real ID
}

async function searchInternships() {
    const keyword  = document.getElementById("keyword").value;
    const major    = document.getElementById("majorFilter").value;
    const location = document.getElementById("locationFilter").value;

    const params = new URLSearchParams();
    if (keyword)  params.append("keyword", keyword);
    if (major)    params.append("major", major);
    if (location) params.append("location", location);

    const table       = document.getElementById("resultsTable");
    const body        = document.getElementById("resultsBody");
    const placeholder = document.getElementById("placeholder");

    // Reset UI
    body.innerHTML = "";
    table.style.display = "none";
    placeholder.style.display = "block";
    placeholder.textContent = "Searching...";

    try {
        const response = await fetch(`/api/jobs?${params.toString()}`);

        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }

        const results = await response.json();
        console.log("Jobs from server:", results); // helpful for debugging

        if (!Array.isArray(results) || results.length === 0) {
            placeholder.textContent = "No internships found for your search.";
            table.style.display = "none";
            return;
        }

        // We have results: show table and hide placeholder
        placeholder.style.display = "none";
        table.style.display = "table";

        results.forEach(job => {
            const row = document.createElement("tr");

            // Make sure these property names match what your backend returns
            row.innerHTML = `
                <td>${job.title}</td>
                <td>${job.employer}</td>
                <td>
                  <button onclick="applyForJob(${job.jobId})">
                    Apply
                  </button>
                </td>
            `;

            body.appendChild(row);
        });
    } catch (err) {
        console.error("Error searching internships:", err);
        placeholder.style.display = "block";
        placeholder.textContent = "Error searching internships. Please try again.";
        table.style.display = "none";
    }
}

// Called when the user clicks "Apply" on a row
async function applyForJob(jobId) {
    const studentId = getCurrentStudentId();

    try {
        const app = await createApplication(jobId, studentId);
        alert(`Application submitted! Application ID: ${app.applicationId}`);
    } catch (err) {
        console.error("Apply error:", err);
        alert("Could not submit application. Please try again.");
    }
}

// POST /api/applications to create an application record
async function createApplication(jobId, studentId) {
    const res = await fetch("/api/applications", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            jobId,
            studentId,
            selected: 0
        }),
    });

    if (!res.ok) {
        throw new Error(`Failed to create application: HTTP ${res.status}`);
    }

    return await res.json();
}
</script>



</body>
</html>
